<!doctype html><html lang=ru><head><meta charset=utf-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1" name=viewport><title>Уга буга < 100</title><meta content="Кодерный понедельник" name=description><meta content=https://freecx.github.io/touch-icon.png property=og:image><link href=https://code.cdn.mozilla.net/fonts/fira.css rel=stylesheet><link href=https://freecx.github.io/favicon.png rel=icon><link href=https://freecx.github.io/touch-icon.png rel=apple-touch-icon><link href=https://freecx.github.io/main.css rel=stylesheet><link href=https://freecx.github.io/syntax.css rel=stylesheet><body><aside class=logo><a href=https://github.com/FreeCX> <img class=gravatar src=https://freecx.github.io/avatar.png> </a><span class=logo-prompt>Я на github</span></aside><article><div class=center><h1>Уга буга < 100</h1><time>1 April 2024</time></div><div class=divider></div><h1 id=uga-buga>уга буга</h1><pre class=language-rust data-lang=rust style=color:#111;background-color:#f9f9f9><code class=language-rust data-lang=rust><span style=color:#8959a8>use </span><span>std::collections::BTreeMap;
</span><span style=color:#8959a8>use </span><span>std::fs::File;
</span><span style=color:#8959a8>use </span><span>std::io::{BufWriter, Write};
</span><span>
</span><span style=color:#8959a8>type </span><span>Palette </span><span style=color:#3e999f>= </span><span>BTreeMap<</span><span style=color:#8959a8>u16</span><span>, Color>;
</span><span style=color:#8959a8>type </span><span>Func </span><span style=color:#3e999f>=</span><span> dyn </span><span style=color:#c99e00>Fn</span><span>(Point) -> </span><span style=color:#8959a8>f32</span><span>;
</span><span>
</span><span style=color:#8959a8>struct </span><span>Point(</span><span style=color:#8959a8>f32</span><span>, </span><span style=color:#8959a8>f32</span><span>);
</span><span style=color:#8959a8>struct </span><span>Color(</span><span style=color:#8959a8>u8</span><span>, </span><span style=color:#8959a8>u8</span><span>, </span><span style=color:#8959a8>u8</span><span>);
</span><span>
</span><span style=color:#8959a8>struct </span><span>Generator {
</span><span>    </span><span style=color:#c82728>size</span><span>: (</span><span style=color:#8959a8>u32</span><span>, </span><span style=color:#8959a8>u32</span><span>),
</span><span>    </span><span style=color:#c82728>x</span><span>: (</span><span style=color:#8959a8>f32</span><span>, </span><span style=color:#8959a8>f32</span><span>),
</span><span>    </span><span style=color:#c82728>y</span><span>: (</span><span style=color:#8959a8>f32</span><span>, </span><span style=color:#8959a8>f32</span><span>),
</span><span>}
</span><span>
</span><span style=color:#8959a8>struct </span><span>Render {
</span><span>    </span><span style=color:#c82728>raw</span><span>: </span><span style=color:#c99e00>Vec</span><span><</span><span style=color:#8959a8>f32</span><span>>,
</span><span>    </span><span style=color:#c82728>size</span><span>: (</span><span style=color:#8959a8>u32</span><span>, </span><span style=color:#8959a8>u32</span><span>),
</span><span>}
</span><span>
</span><span style=color:#8959a8>impl </span><span>Generator {
</span><span>    </span><span style=color:#8959a8>fn </span><span style=color:#4271ae>fill</span><span>(</span><span style=color:#3e999f>&</span><span style=color:#f07219>self</span><span>, </span><span style=color:#f07219>func</span><span>: </span><span style=color:#3e999f>&</span><span>Func) -> Render {
</span><span>        </span><span style=color:#8959a8>let</span><span> iterations </span><span style=color:#3e999f>= </span><span>(</span><span style=color:#c82728>self</span><span>.size.</span><span style=color:#f07219>0 </span><span style=color:#3e999f>* </span><span style=color:#c82728>self</span><span>.size.</span><span style=color:#f07219>1</span><span>) </span><span style=color:#3e999f>as </span><span style=color:#8959a8>usize</span><span>;
</span><span>        </span><span style=color:#8959a8>let</span><span> x_step </span><span style=color:#3e999f>= </span><span>(</span><span style=color:#c82728>self</span><span>.x.</span><span style=color:#f07219>1 </span><span style=color:#3e999f>- </span><span style=color:#c82728>self</span><span>.x.</span><span style=color:#f07219>0</span><span>) </span><span style=color:#3e999f>/ </span><span style=color:#c82728>self</span><span>.size.</span><span style=color:#f07219>0 </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32</span><span>;
</span><span>        </span><span style=color:#8959a8>let</span><span> y_step </span><span style=color:#3e999f>= </span><span>(</span><span style=color:#c82728>self</span><span>.y.</span><span style=color:#f07219>1 </span><span style=color:#3e999f>- </span><span style=color:#c82728>self</span><span>.y.</span><span style=color:#f07219>0</span><span>) </span><span style=color:#3e999f>/ </span><span style=color:#c82728>self</span><span>.size.</span><span style=color:#f07219>1 </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32</span><span>;
</span><span>        </span><span style=color:#8959a8>let mut</span><span> result </span><span style=color:#3e999f>=</span><span> Render { raw: vec![</span><span style=color:#f07219>0.0</span><span>; iterations], size: </span><span style=color:#c82728>self</span><span>.size };
</span><span>        </span><span style=color:#8959a8>let </span><span>(</span><span style=color:#8959a8>mut</span><span> minv, </span><span style=color:#8959a8>mut</span><span> maxv) </span><span style=color:#3e999f>= </span><span>(</span><span style=color:#c99e00>None</span><span>, </span><span style=color:#c99e00>None</span><span>);
</span><span>
</span><span>        </span><span style=color:#8959a8>for </span><span>(index, value) </span><span style=color:#3e999f>in</span><span> result.raw.</span><span style=color:#4271ae>iter_mut</span><span>().</span><span style=color:#4271ae>enumerate</span><span>() {
</span><span>            </span><span style=color:#8959a8>let</span><span> ix </span><span style=color:#3e999f>= </span><span>(index </span><span style=color:#3e999f>as </span><span style=color:#8959a8>u32 </span><span style=color:#3e999f>% </span><span style=color:#c82728>self</span><span>.size.</span><span style=color:#f07219>0</span><span>) </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32</span><span>;
</span><span>            </span><span style=color:#8959a8>let</span><span> iy </span><span style=color:#3e999f>= </span><span>(index </span><span style=color:#3e999f>as </span><span style=color:#8959a8>u32 </span><span style=color:#3e999f>/ </span><span style=color:#c82728>self</span><span>.size.</span><span style=color:#f07219>0</span><span>) </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32</span><span>;
</span><span>            </span><span style=color:#3e999f>*</span><span>value </span><span style=color:#3e999f>= </span><span style=color:#4271ae>func</span><span>(Point(</span><span style=color:#c82728>self</span><span>.x.</span><span style=color:#f07219>0 </span><span style=color:#3e999f>+</span><span> ix </span><span style=color:#3e999f>*</span><span> x_step, </span><span style=color:#c82728>self</span><span>.y.</span><span style=color:#f07219>0 </span><span style=color:#3e999f>+</span><span> iy </span><span style=color:#3e999f>*</span><span> y_step));
</span><span>            minv </span><span style=color:#3e999f>= </span><span style=color:#c99e00>Some</span><span>(minv.</span><span style=color:#4271ae>map_or</span><span>(</span><span style=color:#3e999f>*</span><span>value, |</span><span style=color:#f07219>item</span><span>: </span><span style=color:#8959a8>f32</span><span>| item.</span><span style=color:#4271ae>min</span><span>(</span><span style=color:#3e999f>*</span><span>value)));
</span><span>            maxv </span><span style=color:#3e999f>= </span><span style=color:#c99e00>Some</span><span>(maxv.</span><span style=color:#4271ae>map_or</span><span>(</span><span style=color:#3e999f>*</span><span>value, |</span><span style=color:#f07219>item</span><span>: </span><span style=color:#8959a8>f32</span><span>| item.</span><span style=color:#4271ae>max</span><span>(</span><span style=color:#3e999f>*</span><span>value)));
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#8959a8>let</span><span> minv </span><span style=color:#3e999f>=</span><span> minv.</span><span style=color:#4271ae>unwrap_or</span><span>(</span><span style=color:#f07219>0.0</span><span>).</span><span style=color:#4271ae>abs</span><span>();
</span><span>        </span><span style=color:#8959a8>let</span><span> range </span><span style=color:#3e999f>=</span><span> minv </span><span style=color:#3e999f>+</span><span> maxv.</span><span style=color:#4271ae>unwrap_or</span><span>(</span><span style=color:#f07219>0.0</span><span>).</span><span style=color:#4271ae>abs</span><span>();
</span><span>        </span><span style=color:#8959a8>for</span><span> value </span><span style=color:#3e999f>in</span><span> result.raw.</span><span style=color:#4271ae>iter_mut</span><span>() {
</span><span>            </span><span style=color:#3e999f>*</span><span>value </span><span style=color:#3e999f>= </span><span>(</span><span style=color:#3e999f>*</span><span>value </span><span style=color:#3e999f>+</span><span> minv) </span><span style=color:#3e999f>/</span><span> range;
</span><span>        }
</span><span>
</span><span>        result
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#8959a8>fn </span><span style=color:#4271ae>linear_gradient_palette</span><span>(</span><span style=color:#f07219>c1</span><span>: Color, </span><span style=color:#f07219>c2</span><span>: Color, </span><span style=color:#f07219>n</span><span>: </span><span style=color:#8959a8>u16</span><span>) -> Palette {
</span><span>    </span><span style=color:#8959a8>let mut</span><span> map </span><span style=color:#3e999f>= </span><span>Palette::new();
</span><span>
</span><span>    </span><span style=color:#8959a8>for</span><span> i </span><span style=color:#3e999f>in </span><span style=color:#f07219>0</span><span style=color:#3e999f>..</span><span>n {
</span><span>        </span><span style=color:#8959a8>let</span><span> t </span><span style=color:#3e999f>=</span><span> i </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32 </span><span style=color:#3e999f>/</span><span> n </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32</span><span>;
</span><span>        </span><span style=color:#8959a8>let</span><span> r </span><span style=color:#3e999f>= </span><span>((</span><span style=color:#f07219>1.0 </span><span style=color:#3e999f>-</span><span> t) </span><span style=color:#3e999f>*</span><span> c1.</span><span style=color:#f07219>0 </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32 </span><span style=color:#3e999f>+</span><span> t </span><span style=color:#3e999f>*</span><span> c2.</span><span style=color:#f07219>0 </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32</span><span>) </span><span style=color:#3e999f>as </span><span style=color:#8959a8>u8</span><span>;
</span><span>        </span><span style=color:#8959a8>let</span><span> g </span><span style=color:#3e999f>= </span><span>((</span><span style=color:#f07219>1.0 </span><span style=color:#3e999f>-</span><span> t) </span><span style=color:#3e999f>*</span><span> c1.</span><span style=color:#f07219>1 </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32 </span><span style=color:#3e999f>+</span><span> t </span><span style=color:#3e999f>*</span><span> c2.</span><span style=color:#f07219>1 </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32</span><span>) </span><span style=color:#3e999f>as </span><span style=color:#8959a8>u8</span><span>;
</span><span>        </span><span style=color:#8959a8>let</span><span> b </span><span style=color:#3e999f>= </span><span>((</span><span style=color:#f07219>1.0 </span><span style=color:#3e999f>-</span><span> t) </span><span style=color:#3e999f>*</span><span> c1.</span><span style=color:#f07219>2 </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32 </span><span style=color:#3e999f>+</span><span> t </span><span style=color:#3e999f>*</span><span> c2.</span><span style=color:#f07219>2 </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32</span><span>) </span><span style=color:#3e999f>as </span><span style=color:#8959a8>u8</span><span>;
</span><span>        map.</span><span style=color:#4271ae>insert</span><span>(i, Color(r, g, b));
</span><span>    }
</span><span>
</span><span>    map
</span><span>}
</span><span>
</span><span style=color:#8959a8>fn </span><span style=color:#4271ae>generate_ppm</span><span>(</span><span style=color:#f07219>output</span><span>: </span><span style=color:#3e999f>&</span><span style=color:#8959a8>str</span><span>, </span><span style=color:#f07219>render</span><span>: </span><span style=color:#3e999f>&</span><span>Render, </span><span style=color:#f07219>palette</span><span>: </span><span style=color:#3e999f>&</span><span>Palette) {
</span><span>    </span><span style=color:#8959a8>let mut</span><span> buffer </span><span style=color:#3e999f>= </span><span style=color:#c99e00>Vec</span><span>::new();
</span><span>    </span><span style=color:#8959a8>let </span><span style=color:#3e999f>_ = </span><span>write!(buffer, </span><span style=color:#839c00>"P6</span><span style=color:#f07219>\n</span><span>{} {}</span><span style=color:#f07219>\n</span><span style=color:#839c00>255</span><span style=color:#f07219>\n</span><span style=color:#839c00>"</span><span>, render.size.</span><span style=color:#f07219>0</span><span>, render.size.</span><span style=color:#f07219>1</span><span>);
</span><span>
</span><span>    </span><span style=color:#8959a8>for</span><span> point </span><span style=color:#3e999f>in &</span><span>render.raw {
</span><span>        </span><span style=color:#8959a8>let</span><span> index </span><span style=color:#3e999f>= </span><span>((palette.</span><span style=color:#4271ae>len</span><span>() </span><span style=color:#3e999f>- </span><span style=color:#f07219>1</span><span>) </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32 </span><span style=color:#3e999f>* </span><span>(</span><span style=color:#3e999f>*</span><span>point)) </span><span style=color:#3e999f>as </span><span style=color:#8959a8>u16</span><span>;
</span><span>        </span><span style=color:#8959a8>let</span><span> color </span><span style=color:#3e999f>=</span><span> palette.</span><span style=color:#4271ae>get</span><span>(</span><span style=color:#3e999f>&</span><span>index).</span><span style=color:#4271ae>unwrap_or</span><span>(</span><span style=color:#3e999f>&</span><span>Color(</span><span style=color:#f07219>0</span><span>, </span><span style=color:#f07219>0</span><span>, </span><span style=color:#f07219>0</span><span>));
</span><span>        buffer.</span><span style=color:#4271ae>extend_from_slice</span><span>(</span><span style=color:#3e999f>&</span><span>[color.</span><span style=color:#f07219>0</span><span>, color.</span><span style=color:#f07219>1</span><span>, color.</span><span style=color:#f07219>2</span><span>]);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#8959a8>let mut</span><span> f </span><span style=color:#3e999f>= </span><span>BufWriter::new(File::create(output).</span><span style=color:#4271ae>unwrap</span><span>());
</span><span>    </span><span style=color:#8959a8>let </span><span style=color:#3e999f>_ =</span><span> f.</span><span style=color:#4271ae>write</span><span>(</span><span style=color:#3e999f>&</span><span>buffer);
</span><span>}
</span><span>
</span><span style=color:#8959a8>fn </span><span style=color:#4271ae>render</span><span>(</span><span style=color:#f07219>point</span><span>: Point) -> </span><span style=color:#8959a8>f32 </span><span>{
</span><span>    </span><span style=color:#8959a8>let </span><span>(</span><span style=color:#8959a8>mut</span><span> x, </span><span style=color:#8959a8>mut</span><span> y, </span><span style=color:#8959a8>mut</span><span> iter): (</span><span style=color:#8959a8>f32</span><span>, </span><span style=color:#8959a8>f32</span><span>, </span><span style=color:#3e999f>_</span><span>) </span><span style=color:#3e999f>= </span><span>(</span><span style=color:#f07219>0.0</span><span>, </span><span style=color:#f07219>0.0</span><span>, </span><span style=color:#f07219>0</span><span>);
</span><span>
</span><span>    </span><span style=color:#8959a8>while</span><span> x.</span><span style=color:#4271ae>powi</span><span>(</span><span style=color:#f07219>2</span><span>) </span><span style=color:#3e999f>+</span><span> y.</span><span style=color:#4271ae>powi</span><span>(</span><span style=color:#f07219>2</span><span>) </span><span style=color:#3e999f>< </span><span style=color:#f07219>4.0 </span><span style=color:#3e999f>&&</span><span> iter </span><span style=color:#3e999f>< </span><span style=color:#f07219>20 </span><span>{
</span><span>        </span><span style=color:#8959a8>let</span><span> xt </span><span style=color:#3e999f>=</span><span> x.</span><span style=color:#4271ae>powi</span><span>(</span><span style=color:#f07219>2</span><span>) </span><span style=color:#3e999f>-</span><span> y.</span><span style=color:#4271ae>powi</span><span>(</span><span style=color:#f07219>2</span><span>) </span><span style=color:#3e999f>+</span><span> point.</span><span style=color:#f07219>0</span><span>;
</span><span>        y </span><span style=color:#3e999f>= </span><span style=color:#f07219>2.0 </span><span style=color:#3e999f>*</span><span> x </span><span style=color:#3e999f>*</span><span> y </span><span style=color:#3e999f>+</span><span> point.</span><span style=color:#f07219>1</span><span>;
</span><span>        x </span><span style=color:#3e999f>=</span><span> xt;
</span><span>        iter </span><span style=color:#3e999f>+= </span><span style=color:#f07219>1</span><span>;
</span><span>    }
</span><span>
</span><span>    iter </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32
</span><span>}
</span><span>
</span><span style=color:#8959a8>fn </span><span style=color:#4271ae>main</span><span>() {
</span><span>    </span><span style=color:#8959a8>let</span><span> palette </span><span style=color:#3e999f>= </span><span style=color:#4271ae>linear_gradient_palette</span><span>(Color(</span><span style=color:#f07219>0</span><span>, </span><span style=color:#f07219>0</span><span>, </span><span style=color:#f07219>0</span><span>), Color(</span><span style=color:#f07219>255</span><span>, </span><span style=color:#f07219>255</span><span>, </span><span style=color:#f07219>255</span><span>), </span><span style=color:#f07219>255</span><span>);
</span><span>    </span><span style=color:#8959a8>let</span><span> result </span><span style=color:#3e999f>=</span><span> Generator { size: (</span><span style=color:#f07219>3840</span><span>, </span><span style=color:#f07219>2160</span><span>), x: (</span><span style=color:#3e999f>-</span><span style=color:#f07219>2.2</span><span>, </span><span style=color:#f07219>1.0</span><span>), y: (</span><span style=color:#3e999f>-</span><span style=color:#f07219>1.2</span><span>, </span><span style=color:#f07219>1.2</span><span>) }.</span><span style=color:#4271ae>fill</span><span>(</span><span style=color:#3e999f>&</span><span>render);
</span><span>    </span><span style=color:#4271ae>generate_ppm</span><span>(</span><span style=color:#839c00>"mandelbrot_set.ppm"</span><span>, </span><span style=color:#3e999f>&</span><span>result, </span><span style=color:#3e999f>&</span><span>palette);
</span><span>}
</span></code></pre><h1 id=uga-buga-1>уга буга!</h1><p><img title="unga bunga" alt=unga-bunga src=/posts/mandelbrot_set.jpg><h1 id=uga-buga-2>уга буга</h1><ul><li><a href=https://github.com/FreeCX/abstracto>уга буга</a></ul></article><div class=back><a href=https://freecx.github.io/>Назад</a></div><div class=footer><span>Также читайте <a title="ты сам сломал ссылку, так что ничего личного" href=https://antoniii.github.io/> <s>antoniii</s> </a> <a href=https://citrux.github.io/>citrux</a> <a href=https://sputnikas.github.io/>sputnikas</a> </span></div><script>let msg=` А спонсор статей в моём блоге -- моя лень -- спонсор статей.`;[`=`.repeat(msg.length+ 1),msg,`=`.repeat(msg.length+ 1)].forEach(a=>console.warn(a))</script>