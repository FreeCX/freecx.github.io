<!doctype html><html lang=ru><head><meta charset=utf-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1" name=viewport><title>Пишем простой генератор звука для азбуки Морзе</title><meta content="Кодерный понедельник" name=description><meta content=https://freecx.github.io/touch-icon.png property=og:image><link href=https://code.cdn.mozilla.net/fonts/fira.css rel=stylesheet><link href=https://freecx.github.io/favicon.png rel=icon><link href=https://freecx.github.io/touch-icon.png rel=apple-touch-icon><link href=https://freecx.github.io/main.css rel=stylesheet><link href=https://freecx.github.io/syntax.css rel=stylesheet><body><aside class=logo><a href=https://github.com/FreeCX> <img class=gravatar src=https://freecx.github.io/avatar.png> </a><span class=logo-prompt>Я на github</span></aside><article><div class=center><h1>Пишем простой генератор звука для азбуки Морзе</h1><time>7 September 2016</time></div><div class=divider></div><p>Давно я не писал что-то в свой блог. Надо исправлять данное недоразумение.<p>Так что давайте напишем генератор звука для азбуки Морзе.<h1 id=teoriia>Теория</h1><p>Здесь должна быть теория по генерации звука, но мне как-то лень, поэтому читайте её по ссылкам приведённым в конце статьи.<h1 id=transliatsiia-teksta>Трансляция текста</h1><p>Для начала нам нужно написать код для трансляции текста в кодовую азбуку Морзе, для этого воспользуемся возможностью предоставляемую нам словарём.<p>Для написания кода я буду использовать язык Rust и библиотеку <code>lazy_static</code>.<pre class=language-rust data-lang=rust style=color:#111;background-color:#f9f9f9><code class=language-rust data-lang=rust><span>#[</span><span style=color:#c82728>macro_use</span><span>]
</span><span style=color:#8959a8>extern crate</span><span> lazy_static;
</span><span style=color:#8959a8>use </span><span>std::collections::HashMap;
</span><span>
</span><span>lazy_static! {
</span><span>    </span><span style=color:#8e908c>// спец. коды
</span><span>    </span><span style=color:#8959a8>static ref </span><span>ERROR_CODE: </span><span style=color:#3e999f>&</span><span style=color:#8959a8>'static str </span><span style=color:#3e999f>= </span><span style=color:#839c00>"········"</span><span>;
</span><span>    </span><span style=color:#8959a8>static ref </span><span>END_TRANSMISSION: </span><span style=color:#3e999f>&</span><span style=color:#8959a8>'static str </span><span style=color:#3e999f>= </span><span style=color:#839c00>"··-·-"</span><span>;
</span><span>    </span><span style=color:#8e908c>// таблица кодов
</span><span>    </span><span style=color:#8959a8>static ref </span><span>MORSE_TABLE: </span><span style=color:#c99e00>Vec</span><span><(</span><span style=color:#3e999f>&</span><span style=color:#8959a8>'static str</span><span>, </span><span style=color:#3e999f>&</span><span style=color:#8959a8>'static str</span><span>)> </span><span style=color:#3e999f>= </span><span>vec![
</span><span>        (</span><span style=color:#839c00>"А"</span><span>, </span><span style=color:#839c00>"·-"</span><span>), (</span><span style=color:#839c00>"Б"</span><span>, </span><span style=color:#839c00>"-···"</span><span>), (</span><span style=color:#839c00>"В"</span><span>, </span><span style=color:#839c00>"·--"</span><span>), (</span><span style=color:#839c00>"Г"</span><span>, </span><span style=color:#839c00>"--·"</span><span>), (</span><span style=color:#839c00>"Д"</span><span>, </span><span style=color:#839c00>"-··"</span><span>), (</span><span style=color:#839c00>"Ё"</span><span>, </span><span style=color:#839c00>"·"</span><span>), (</span><span style=color:#839c00>"Е"</span><span>, </span><span style=color:#839c00>"·"</span><span>),
</span><span>        (</span><span style=color:#839c00>"Ж"</span><span>, </span><span style=color:#839c00>"···-"</span><span>), (</span><span style=color:#839c00>"З"</span><span>, </span><span style=color:#839c00>"--··"</span><span>), (</span><span style=color:#839c00>"И"</span><span>, </span><span style=color:#839c00>"··"</span><span>), (</span><span style=color:#839c00>"Й"</span><span>, </span><span style=color:#839c00>"·---"</span><span>), (</span><span style=color:#839c00>"К"</span><span>, </span><span style=color:#839c00>"-·-"</span><span>), (</span><span style=color:#839c00>"Л"</span><span>, </span><span style=color:#839c00>"·-··"</span><span>), (</span><span style=color:#839c00>"М"</span><span>, </span><span style=color:#839c00>"--"</span><span>), 
</span><span>        (</span><span style=color:#839c00>"Н"</span><span>, </span><span style=color:#839c00>"-·"</span><span>), (</span><span style=color:#839c00>"О"</span><span>, </span><span style=color:#839c00>"---"</span><span>), (</span><span style=color:#839c00>"П"</span><span>, </span><span style=color:#839c00>"·--·"</span><span>), (</span><span style=color:#839c00>"Р"</span><span>, </span><span style=color:#839c00>"·-·"</span><span>), (</span><span style=color:#839c00>"С"</span><span>, </span><span style=color:#839c00>"···"</span><span>), (</span><span style=color:#839c00>"Т"</span><span>, </span><span style=color:#839c00>"-"</span><span>), (</span><span style=color:#839c00>"У"</span><span>, </span><span style=color:#839c00>"··-"</span><span>), 
</span><span>        (</span><span style=color:#839c00>"Ф"</span><span>, </span><span style=color:#839c00>"··-·"</span><span>), (</span><span style=color:#839c00>"Х"</span><span>, </span><span style=color:#839c00>"····"</span><span>), (</span><span style=color:#839c00>"Ц"</span><span>, </span><span style=color:#839c00>"-·-·"</span><span>), (</span><span style=color:#839c00>"Ч"</span><span>, </span><span style=color:#839c00>"---·"</span><span>), (</span><span style=color:#839c00>"Ш"</span><span>, </span><span style=color:#839c00>"----"</span><span>), (</span><span style=color:#839c00>"Щ"</span><span>, </span><span style=color:#839c00>"--·-"</span><span>), 
</span><span>        (</span><span style=color:#839c00>"Ъ"</span><span>, </span><span style=color:#839c00>"--·--"</span><span>), (</span><span style=color:#839c00>"Ы"</span><span>, </span><span style=color:#839c00>"-·--"</span><span>), (</span><span style=color:#839c00>"Ь"</span><span>, </span><span style=color:#839c00>"-··-"</span><span>), (</span><span style=color:#839c00>"Э"</span><span>, </span><span style=color:#839c00>"··-··"</span><span>), (</span><span style=color:#839c00>"Ю"</span><span>, </span><span style=color:#839c00>"··--"</span><span>), (</span><span style=color:#839c00>"Я"</span><span>, </span><span style=color:#839c00>"·-·-"</span><span>), 
</span><span>        (</span><span style=color:#839c00>"1"</span><span>, </span><span style=color:#839c00>"·----"</span><span>), (</span><span style=color:#839c00>"2"</span><span>, </span><span style=color:#839c00>"··---"</span><span>), (</span><span style=color:#839c00>"3"</span><span>, </span><span style=color:#839c00>"···--"</span><span>), (</span><span style=color:#839c00>"4"</span><span>, </span><span style=color:#839c00>"····-"</span><span>), (</span><span style=color:#839c00>"5"</span><span>, </span><span style=color:#839c00>"·····"</span><span>), (</span><span style=color:#839c00>"6"</span><span>, </span><span style=color:#839c00>"-····"</span><span>), 
</span><span>        (</span><span style=color:#839c00>"7"</span><span>, </span><span style=color:#839c00>"--···"</span><span>), (</span><span style=color:#839c00>"8"</span><span>, </span><span style=color:#839c00>"---··"</span><span>), (</span><span style=color:#839c00>"9"</span><span>, </span><span style=color:#839c00>"----·"</span><span>), (</span><span style=color:#839c00>"0"</span><span>, </span><span style=color:#839c00>"-----"</span><span>), (</span><span style=color:#839c00>"."</span><span>, </span><span style=color:#839c00>"······"</span><span>), (</span><span style=color:#839c00>","</span><span>, </span><span style=color:#839c00>"·-·-·-"</span><span>), 
</span><span>        (</span><span style=color:#839c00>":"</span><span>, </span><span style=color:#839c00>"---···"</span><span>), (</span><span style=color:#839c00>";"</span><span>, </span><span style=color:#839c00>"-·-·-·"</span><span>), (</span><span style=color:#839c00>")"</span><span>, </span><span style=color:#839c00>"-·--·-"</span><span>), (</span><span style=color:#839c00>"("</span><span>, </span><span style=color:#839c00>"-·--·-"</span><span>), (</span><span style=color:#839c00>"'"</span><span>, </span><span style=color:#839c00>"·----·"</span><span>), (</span><span style=color:#839c00>"-"</span><span>, </span><span style=color:#839c00>"-····-"</span><span>), 
</span><span>        (</span><span style=color:#839c00>"</span><span style=color:#f07219>\\</span><span style=color:#839c00>"</span><span>, </span><span style=color:#839c00>"-··-·"</span><span>), (</span><span style=color:#839c00>"/"</span><span>, </span><span style=color:#839c00>"-··-·"</span><span>), (</span><span style=color:#839c00>"!"</span><span>, </span><span style=color:#839c00>"··--··"</span><span>),  (</span><span style=color:#839c00>"?"</span><span>, </span><span style=color:#839c00>"--··--"</span><span>), (</span><span style=color:#839c00>" "</span><span>, </span><span style=color:#839c00>"-···-"</span><span>), (</span><span style=color:#839c00>"@"</span><span>, </span><span style=color:#839c00>"·--·-·"</span><span>)
</span><span>    ];
</span><span>    </span><span style=color:#8e908c>// генерируем словарь
</span><span>    </span><span style=color:#8959a8>static ref </span><span>CODER: HashMap<</span><span style=color:#c99e00>String</span><span>, </span><span style=color:#c99e00>String</span><span>> </span><span style=color:#3e999f>= </span><span>{
</span><span>        </span><span style=color:#8959a8>let mut</span><span> hashmap </span><span style=color:#3e999f>= </span><span>HashMap::new();
</span><span>        </span><span style=color:#8959a8>for </span><span style=color:#3e999f>&</span><span>(symbol, morse) </span><span style=color:#3e999f>in </span><span>MORSE_TABLE.</span><span style=color:#4271ae>iter</span><span>() {
</span><span>            hashmap.</span><span style=color:#4271ae>insert</span><span>(symbol.</span><span style=color:#4271ae>to_string</span><span>(), morse.</span><span style=color:#4271ae>to_string</span><span>());
</span><span>        }
</span><span>        hashmap
</span><span>    };
</span><span>}
</span><span>
</span><span style=color:#8e908c>// функция кодирования
</span><span style=color:#8959a8>fn </span><span style=color:#4271ae>encode</span><span>(</span><span style=color:#f07219>input</span><span>: </span><span style=color:#3e999f>&</span><span style=color:#8959a8>str</span><span>) -> String {
</span><span>    </span><span style=color:#8959a8>let mut</span><span> result </span><span style=color:#3e999f>= </span><span style=color:#c99e00>String</span><span>::new();
</span><span>    </span><span style=color:#8e908c>// перегоняем текст в ЗАГЛАВНЫЙ формат
</span><span>    </span><span style=color:#8959a8>let</span><span> input_str </span><span style=color:#3e999f>=</span><span> input.</span><span style=color:#4271ae>to_uppercase</span><span>();
</span><span>    </span><span style=color:#8959a8>for</span><span> symbol </span><span style=color:#3e999f>in</span><span> input_str.</span><span style=color:#4271ae>chars</span><span>() {
</span><span>        </span><span style=color:#8959a8>match </span><span>CODER.</span><span style=color:#4271ae>get</span><span>(</span><span style=color:#3e999f>&</span><span>format!(</span><span style=color:#839c00>"</span><span>{}</span><span style=color:#839c00>"</span><span>, symbol)) {
</span><span>            </span><span style=color:#8e908c>// кодируем символ
</span><span>            </span><span style=color:#c99e00>Some</span><span>(code) </span><span style=color:#3e999f>=></span><span> result.</span><span style=color:#4271ae>push_str</span><span>(</span><span style=color:#3e999f>&</span><span>format!(</span><span style=color:#839c00>"</span><span>{} </span><span style=color:#839c00>"</span><span>, code)),
</span><span>            </span><span style=color:#8e908c>// игнорим остальные символы
</span><span>            </span><span style=color:#c99e00>None </span><span style=color:#3e999f>=> </span><span>()
</span><span>        };
</span><span>    }
</span><span>    </span><span style=color:#8e908c>// добавляем индификатор конца трансляции
</span><span>    result.</span><span style=color:#4271ae>push_str</span><span>(</span><span style=color:#3e999f>&</span><span>END_TRANSMISSION);
</span><span>    result
</span><span>}
</span></code></pre><p>Теперь у нас есть функционал отвечающий за преобразования текста в код Морзе.<p>Так давайте перейдём к генерации звука!<h1 id=generatsiia-zvuka>Генерация звука</h1><p>Как и писал ранее, вся теория по генерации звука находится в конце. За справкой обращайтесь туда.<p>Я же покажу всё в виде кода. Для генерации звука будем использовать синус. Нам понадобится только три параметра:<ul><li>частота, Герцы<li>продолжительность, секунды<li>громкость, значение в интервале [0, 1].</ul><p>Собственно код:<pre class=language-rust data-lang=rust style=color:#111;background-color:#f9f9f9><code class=language-rust data-lang=rust><span style=color:#8959a8>fn </span><span style=color:#4271ae>generate</span><span>(</span><span style=color:#f07219>freq</span><span>: </span><span style=color:#8959a8>f32</span><span>, </span><span style=color:#f07219>duration</span><span>: </span><span style=color:#8959a8>f32</span><span>, </span><span style=color:#f07219>volume</span><span>: </span><span style=color:#8959a8>f32</span><span>) -> </span><span style=color:#c99e00>Vec</span><span><</span><span style=color:#8959a8>u8</span><span>> {
</span><span>    </span><span style=color:#8e908c>// частота дискретизации
</span><span>    </span><span style=color:#8959a8>let</span><span> sample_rate </span><span style=color:#3e999f>= </span><span style=color:#f07219>44100</span><span>;
</span><span>    </span><span style=color:#8e908c>// амплитуда определяется максимальным значением для i16 умноженая на громкость
</span><span>    </span><span style=color:#8959a8>let</span><span> amplitude </span><span style=color:#3e999f>= </span><span>std::i16::MAX </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32 </span><span style=color:#3e999f>*</span><span> volume;
</span><span>    </span><span style=color:#8e908c>// количество генерируемых сэмплов
</span><span>    </span><span style=color:#8959a8>let</span><span> total_samples: </span><span style=color:#8959a8>u32 </span><span style=color:#3e999f>= </span><span>(sample_rate </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32 </span><span style=color:#3e999f>*</span><span> duration).</span><span style=color:#4271ae>round</span><span>() </span><span style=color:#3e999f>as </span><span style=color:#8959a8>u32</span><span>;
</span><span>    </span><span style=color:#8e908c>// угловая частота / частоте дискретизации
</span><span>    </span><span style=color:#8959a8>let</span><span> w </span><span style=color:#3e999f>= </span><span>std::f32::consts::TAU </span><span style=color:#3e999f>*</span><span> freq </span><span style=color:#3e999f>/</span><span> sample_rate </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32</span><span>;
</span><span>    </span><span style=color:#8e908c>// мы будем делать i16, а записывать по 2 блока u8 в формате little endian
</span><span>    </span><span style=color:#8959a8>let mut</span><span> buffer: </span><span style=color:#c99e00>Vec</span><span><</span><span style=color:#8959a8>u8</span><span>> </span><span style=color:#3e999f>= </span><span style=color:#c99e00>Vec</span><span>::with_capacity(</span><span style=color:#f07219>2 </span><span style=color:#3e999f>*</span><span> total_samples </span><span style=color:#3e999f>as </span><span style=color:#8959a8>usize</span><span>);
</span><span>    </span><span style=color:#8959a8>for</span><span> k </span><span style=color:#3e999f>in </span><span style=color:#f07219>0</span><span style=color:#3e999f>..</span><span>total_samples {
</span><span>        </span><span style=color:#8e908c>// f = A * sin(kw)
</span><span>        </span><span style=color:#8e908c>// A -- амплитуда сигнала
</span><span>        </span><span style=color:#8e908c>// k -- номер сэмпла
</span><span>        </span><span style=color:#8959a8>let</span><span> sample </span><span style=color:#3e999f>= </span><span>(amplitude </span><span style=color:#3e999f>* </span><span>(k </span><span style=color:#3e999f>as </span><span style=color:#8959a8>f32 </span><span style=color:#3e999f>*</span><span> w).</span><span style=color:#4271ae>sin</span><span>()) </span><span style=color:#3e999f>as </span><span style=color:#8959a8>i16</span><span>;
</span><span>        </span><span style=color:#8e908c>// проталкиваем в буффер
</span><span>        buffer.</span><span style=color:#4271ae>extend_from_slice</span><span>(</span><span style=color:#3e999f>&</span><span>sample.</span><span style=color:#4271ae>to_le_bytes</span><span>());
</span><span>    }
</span><span>    buffer
</span><span>}
</span></code></pre><p>Обратите внимание, что я использовал функцию определяющую порядок представления байт в итоговом файле. Она является не столь важным элементом, но мы же хорошие программисты и хотим быть точно уверены в правильном представлении звука.<h1 id=sobiraem-zvukovuiu-dorozhku>Собираем звуковую дорожку</h1><p>Теперь когда мы имеем транслятор и генератор остаётся только собрать всё в одну дорожку.<p>План у нас такой:<ul><li>сгенерировать звука для 'точки'<li>сгенерировать звук для 'тире'<li>сгенерировать звук для паузы<li>собрать дорожку по строке с кодом Морзе</ul><p>Для звука 'точки' будем использовать частоту в 300 Герц длительностью 0.15 и громкостью 1. Остальную информацию возьмём из вики:<blockquote><p>За единицу времени принимается длительность одной точки. Длительность тире равна трём точкам. Пауза между элементами одного знака — одна точка, между знаками в слове — 3 точки, между словами — 7 точек</blockquote><pre class=language-rust data-lang=rust style=color:#111;background-color:#f9f9f9><code class=language-rust data-lang=rust><span style=color:#8e908c>// весь предыдущий код
</span><span>
</span><span style=color:#8959a8>fn </span><span style=color:#4271ae>main</span><span>() {
</span><span>    </span><span style=color:#8e908c>// длительность звучания 'точки'
</span><span>    </span><span style=color:#8959a8>let</span><span> dot_len </span><span style=color:#3e999f>= </span><span style=color:#f07219>0.15</span><span>;
</span><span>    </span><span style=color:#8e908c>// вектор для наших сэмплов
</span><span>    </span><span style=color:#8959a8>let mut</span><span> result_audio: </span><span style=color:#c99e00>Vec</span><span><</span><span style=color:#8959a8>u8</span><span>> </span><span style=color:#3e999f>= </span><span style=color:#c99e00>Vec</span><span>::new();
</span><span>    </span><span style=color:#8e908c>// звук одной 'точки'
</span><span>    </span><span style=color:#8959a8>let</span><span> dot </span><span style=color:#3e999f>= </span><span style=color:#4271ae>generate</span><span>(</span><span style=color:#f07219>300.0</span><span>, dot_len, </span><span style=color:#f07219>1.0</span><span>);
</span><span>    </span><span style=color:#8e908c>// и соответственно 'тире'
</span><span>    </span><span style=color:#8959a8>let</span><span> dash </span><span style=color:#3e999f>= </span><span style=color:#4271ae>generate</span><span>(</span><span style=color:#f07219>300.0</span><span>, </span><span style=color:#f07219>3.0 </span><span style=color:#3e999f>*</span><span> dot_len, </span><span style=color:#f07219>1.0</span><span>);
</span><span>    </span><span style=color:#8e908c>// собираем 44100 * 3 * dot_len нулей (u16 или по два для u8) для паузы между знаками
</span><span>    </span><span style=color:#8959a8>let</span><span> e_pause </span><span style=color:#3e999f>= </span><span>vec![</span><span style=color:#f07219>0_</span><span style=color:#8959a8>u8</span><span>; </span><span style=color:#f07219>2 </span><span style=color:#3e999f>* </span><span>(</span><span style=color:#f07219>44100.0 </span><span style=color:#3e999f>* </span><span style=color:#f07219>3.0 </span><span style=color:#3e999f>*</span><span> dot_len).</span><span style=color:#4271ae>round</span><span>() </span><span style=color:#3e999f>as </span><span style=color:#8959a8>usize</span><span>];
</span><span>    </span><span style=color:#8e908c>// собираем 44100 * 7 * dot_len нулей для паузы между словами
</span><span>    </span><span style=color:#8959a8>let</span><span> w_pause </span><span style=color:#3e999f>= </span><span>vec![</span><span style=color:#f07219>0_</span><span style=color:#8959a8>u8</span><span>; </span><span style=color:#f07219>2 </span><span style=color:#3e999f>* </span><span>(</span><span style=color:#f07219>44100.0 </span><span style=color:#3e999f>* </span><span style=color:#f07219>7.0 </span><span style=color:#3e999f>*</span><span> dot_len).</span><span style=color:#4271ae>round</span><span>() </span><span style=color:#3e999f>as </span><span style=color:#8959a8>usize</span><span>];
</span><span>    </span><span style=color:#8e908c>// собираем 44100 * dot_len нулей для паузы между элементами одного знака
</span><span>    </span><span style=color:#8959a8>let</span><span> s_pause </span><span style=color:#3e999f>= </span><span>vec![</span><span style=color:#f07219>0_</span><span style=color:#8959a8>u8</span><span>; </span><span style=color:#f07219>2 </span><span style=color:#3e999f>* </span><span>(</span><span style=color:#f07219>44100.0 </span><span style=color:#3e999f>*</span><span> dot_len).</span><span style=color:#4271ae>round</span><span>() </span><span style=color:#3e999f>as </span><span style=color:#8959a8>usize</span><span>];
</span><span>    </span><span style=color:#8e908c>// кодируем наш текст
</span><span>    </span><span style=color:#8959a8>let</span><span> morse_text </span><span style=color:#3e999f>= </span><span style=color:#4271ae>encode</span><span>(</span><span style=color:#839c00>"привет мир!"</span><span>);
</span><span>    </span><span style=color:#8959a8>let mut</span><span> last_char </span><span style=color:#3e999f>= </span><span style=color:#839c00>'?'</span><span>;
</span><span>    </span><span style=color:#8959a8>for</span><span> code </span><span style=color:#3e999f>in</span><span> morse_text.</span><span style=color:#4271ae>chars</span><span>() {
</span><span>        </span><span style=color:#8959a8>match</span><span> code {
</span><span>            </span><span style=color:#839c00>'·' </span><span style=color:#3e999f>=></span><span> result_audio.</span><span style=color:#4271ae>extend</span><span>(dot.</span><span style=color:#4271ae>clone</span><span>()),
</span><span>            </span><span style=color:#839c00>'-' </span><span style=color:#3e999f>=></span><span> result_audio.</span><span style=color:#4271ae>extend</span><span>(dash.</span><span style=color:#4271ae>clone</span><span>()),
</span><span>            </span><span style=color:#8e908c>// пауза между словами
</span><span>            </span><span style=color:#839c00>' ' </span><span style=color:#3e999f>=> </span><span>{
</span><span>                result_audio.</span><span style=color:#4271ae>extend</span><span>(w_pause.</span><span style=color:#4271ae>clone</span><span>());
</span><span>                </span><span style=color:#8959a8>continue
</span><span>            }
</span><span>            </span><span style=color:#3e999f>_ => </span><span>{}
</span><span>        };
</span><span>        </span><span style=color:#8959a8>if</span><span> last_char </span><span style=color:#3e999f>==</span><span> code {
</span><span>            </span><span style=color:#8e908c>// пауза между элементами одного знака
</span><span>            result_audio.</span><span style=color:#4271ae>extend</span><span>(s_pause.</span><span style=color:#4271ae>clone</span><span>());
</span><span>        } </span><span style=color:#8959a8>else </span><span>{
</span><span>            </span><span style=color:#8e908c>// пауза между символами
</span><span>            result_audio.</span><span style=color:#4271ae>extend</span><span>(e_pause.</span><span style=color:#4271ae>clone</span><span>());
</span><span>        }
</span><span>        last_char </span><span style=color:#3e999f>=</span><span> code;
</span><span>    }
</span><span>}
</span></code></pre><h1 id=zapis-v-fail-i-vosproizvedenie>Запись в файл и воспроизведение</h1><p>На данном мы уже имеем сгенерированную звуковую последовательность, но для того чтобы его прослушать нам необходимо либо отправить звук на устройство вывода, либо записать в файл.<p>Мы пойдем по пути наименьшего сопротивления и просто запишем данные в файл. А для того чтобы прослушать получившуюся мелодию используем консольную утилиту <code>ffplay</code>.<p>Не будем слишком многословны и перейдём сразу к коду<pre class=language-rust data-lang=rust style=color:#111;background-color:#f9f9f9><code class=language-rust data-lang=rust><span style=color:#8e908c>// место lazy_static и HashMap
</span><span style=color:#8959a8>use </span><span>std::fs::File;
</span><span style=color:#8959a8>use </span><span>std::io::Write;
</span><span>
</span><span style=color:#8e908c>//
</span><span style=color:#8e908c>// место для generate и encode
</span><span style=color:#8e908c>//
</span><span>
</span><span style=color:#8959a8>fn </span><span style=color:#4271ae>main</span><span>() {
</span><span>    </span><span style=color:#8959a8>let mut</span><span> file </span><span style=color:#3e999f>= </span><span>File::create(</span><span style=color:#839c00>"./generated.sound"</span><span>).</span><span style=color:#4271ae>expect</span><span>(</span><span style=color:#839c00>"can't create file!"</span><span>);
</span><span>    </span><span style=color:#8e908c>//
</span><span>    </span><span style=color:#8e908c>// здесь находится генерация звука
</span><span>    </span><span style=color:#8e908c>//
</span><span>    file.</span><span style=color:#4271ae>write_all</span><span>(result_audio.</span><span style=color:#4271ae>as_slice</span><span>());
</span><span>}
</span></code></pre><p>После компиляции и выполнения данного кода получим на выходе файл <code>generated.sound</code>. Прослушать его можно следующей командой:<pre class=language-bash data-lang=bash style=color:#111;background-color:#f9f9f9><code class=language-bash data-lang=bash><span style=color:#c82728>$</span><span style=color:#4271ae> ffplay</span><span style=color:#f07219> -f</span><span style=color:#4271ae> s16le</span><span style=color:#f07219> -ar</span><span style=color:#4271ae> 44k</span><span style=color:#f07219> -ac</span><span style=color:#4271ae> 1 generated.sound
</span></code></pre><p>На этом всё и до встречи через полгода :)<h1 id=poleznye-ssylki>Полезные ссылки</h1><p>[1] <a href=https://ru.wikipedia.org/wiki/%D0%90%D0%B7%D0%B1%D1%83%D0%BA%D0%B0_%D0%9C%D0%BE%D1%80%D0%B7%D0%B5>Азбука Морзе</a><p>[2] <a href=http://www.gamedev.ru/community/rt_proc_sound/articles/rt_softsynth_basics>Процедурная генерация звука в реальном времени</a><p>[3] <a href=https://habrahabr.ru/post/126835/>Программная генерация звуков</a><p>[4] <a href=https://habrahabr.ru/post/178915/>Программный синтезатор</a></article><div class=back><a href=https://freecx.github.io/>Назад</a></div><div class=footer><span>Также читайте <a title="ты сам сломал ссылку, так что ничего личного" href=https://antoniii.github.io/> <s>antoniii</s> </a> <a href=https://citrux.github.io/>citrux</a> <a href=https://sputnikas.github.io/>sputnikas</a> </span></div><script>let msg=` А спонсор статей в моём блоге -- моя лень -- спонсор статей.`;[`=`.repeat(msg.length+ 1),msg,`=`.repeat(msg.length+ 1)].forEach(a=>console.warn(a))</script>